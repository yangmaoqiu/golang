name: Build for LoongArch64

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²è®°å½•
        
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'
        
    - name: Setup Go module
      run: |
        # èŽ·å–é¡¹ç›®åç§°
        REPO_NAME="${GITHUB_REPOSITORY#*/}"
        
        # åˆ›å»ºæˆ–æ›´æ–° go.mod
        if [ -f "go.mod" ]; then
          echo "âœ… go.mod å·²å­˜åœ¨"
          cat go.mod
        else
          echo "ðŸ“¦ åˆ›å»º go.mod..."
          go mod init "github.com/$GITHUB_REPOSITORY"
          
          # æ·»åŠ åŸºæœ¬ä¿¡æ¯
          cat >> go.mod << EOF

// é¡¹ç›®ä¿¡æ¯
// ä»“åº“: https://github.com/$GITHUB_REPOSITORY
// æž„å»ºæ—¶é—´: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
EOF
        fi
        
    - name: Build for LoongArch64
      run: |
        echo "=== ç¼–è¯‘ä¿¡æ¯ ==="
        echo "ä»“åº“: $GITHUB_REPOSITORY"
        echo "æäº¤: ${GITHUB_SHA:0:8}"
        echo "æž¶æž„: linux/loong64"
        echo ""
        
        # ç¼–è¯‘
        GOOS=linux GOARCH=loong64 CGO_ENABLED=0 go build \
          -ldflags="-X 'main.Version=${GITHUB_SHA:0:8}'" \
          -v -o main-loong64 .
        
        echo ""
        echo "=== éªŒè¯ç»“æžœ ==="
        file main-loong64
        echo "å¤§å°: $(ls -lh main-loong64 | awk '{print $5}')"
        
    - name: Create release info
      run: |
        cat > release-info.md << EOF
        # LoongArch64 æž„å»ºç»“æžœ
        
        ## æ–‡ä»¶ä¿¡æ¯
        - æ–‡ä»¶å: main-loong64
        - æž¶æž„: LoongArch64 (é¾™èŠ¯)
        - æ“ä½œç³»ç»Ÿ: Linux
        - é“¾æŽ¥æ–¹å¼: é™æ€é“¾æŽ¥ (çº¯Go)
        
        ## æž„å»ºä¿¡æ¯
        - ä»“åº“: $GITHUB_REPOSITORY
        - æäº¤ID: ${GITHUB_SHA:0:8}
        - æž„å»ºæ—¶é—´: $(date)
        - Goç‰ˆæœ¬: $(go version)
        
        ## ä½¿ç”¨è¯´æ˜Ž
        1. ä¸‹è½½ main-loong64 æ–‡ä»¶
        2. åœ¨é¾™èŠ¯ç”µè„‘ä¸Šæ·»åŠ æ‰§è¡Œæƒé™: \`chmod +x main-loong64\`
        3. è¿è¡Œ: \`./main-loong64\`
        
        ## éªŒè¯å‘½ä»¤
        \`\`\`bash
        file main-loong64
        # åº”è¯¥æ˜¾ç¤º: ELF 64-bit LSB executable, LoongArch-64
        \`\`\`
        EOF
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: loong64-release
        path: |
          main-loong64
          release-info.md
        retention-days: 30
