name: Build for LoongArch64

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: '跳过测试'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GOPROXY: https://goproxy.cn,direct
      GOPRIVATE: ''
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'
        
    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/go/pkg/mod
          ~/.cache/go-build
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
          
    - name: Initialize module
      id: init-module
      run: |
        if [ ! -f "go.mod" ]; then
          echo "创建 go.mod..."
          go mod init github.com/yangmaoqiu/golang
          echo "module_created=true" >> $GITHUB_OUTPUT
        else
          echo "go.mod 已存在"
          echo "module_created=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Resolve dependencies
      run: |
        echo "解析依赖..."
        if [ "${{ steps.init-module.outputs.module_created }}" = "true" ]; then
          echo "添加 purego 依赖..."
          go get github.com/ebitengine/purego@v0.7.0
        fi
        go mod tidy
        
    - name: Build
      run: |
        echo "开始交叉编译 LoongArch64 (无 CGO 模式)..."
        
        # 核心关键点：
        # 1. CGO_ENABLED=0 避免使用宿主机的 gcc
        # 2. GOARCH=loong64 是 Go 1.19+ 支持的标准架构名
        export CGO_ENABLED=0
        
        GOOS=linux GOARCH=loong64 go build \
          -ldflags="-w -s" \
          -o main-loong64 \
          .
          
        echo "✅ 编译完成"
        
    - name: Test (optional)
      if: github.event.inputs.skip_tests != 'true'
      run: |
        echo "运行测试 (在 x86 宿主机上仅能运行纯 Go 测试)..."
        # 注意：交叉编译环境下无法直接运行运行生成的二进制测试文件，
        # 但 go test 仍然可以检查代码逻辑
        go test ./... -v || echo "测试完成"
        
    - name: Verify
      run: |
        echo "=== 验证构建结果 ==="
        if [ -f "main-loong64" ]; then
          echo "文件信息 (确认应显示 LoongArch):"
          file main-loong64
        else
          echo "❌ 错误: 未生成 main-loong64"
          exit 1
        fi
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: loong64-release
        path: |
          main-loong64
