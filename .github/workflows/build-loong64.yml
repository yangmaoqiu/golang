name: Build for LoongArch64

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: '跳过测试'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GOPROXY: https://goproxy.cn,direct
      GOPRIVATE: ''
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'
        
    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/go/pkg/mod
          ~/.cache/go-build
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Install LoongArch Cross-Compiler
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-loongarch64-linux-gnu
          
    - name: Initialize module
      id: init-module
      run: |
        if [ ! -f "go.mod" ]; then
          echo "创建 go.mod..."
          go mod init github.com/yangmaoqiu/golang
          echo "module_created=true" >> $GITHUB_OUTPUT
        else
          echo "go.mod 已存在"
          echo "module_created=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Resolve dependencies
      run: |
        echo "解析依赖..."
        if [ "${{ steps.init-module.outputs.module_created }}" = "true" ]; then
          echo "添加 purego 依赖..."
          go get github.com/ebitengine/purego@v0.7.0
        fi
        go mod tidy
        
    - name: Build
      run: |
        echo "开始交叉编译 LoongArch64 (开启 CGO 以兼容 purego)..."
        
        # 必须开启 CGO 才能解决 purego/internal/fakecgo 的 undefined 错误
        export CGO_ENABLED=1
        
        # 指定交叉编译器
        export CC=loongarch64-linux-gnu-gcc
        
        # 编译命令
        # -extldflags "-static" 建议保留，以减少对龙芯机器上 glibc 版本的依赖
        GOOS=linux GOARCH=loong64 go build \
          -ldflags="-w -s -extldflags '-static'" \
          -o main-loong64 \
          .
          
        echo "✅ 编译完成"
        
    - name: Verify
      run: |
        echo "=== 验证构建结果 ==="
        if [ -f "main-loong64" ]; then
          echo "文件详细信息:"
          file main-loong64
          echo ""
          echo "检查是否为静态链接:"
          ldd main-loong64 2>/dev/null || echo "确认是静态链接或无法在本机解析"
        else
          echo "❌ 错误: 未生成 main-loong64"
          exit 1
        fi
        
    - name: Create release package
      run: |
        echo "创建发布包..."
        cat > VERSION << EOF
Version: 1.0.0
Build: ${{ github.sha }}
Date: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
Arch: loongarch64
OS: linux
EOF
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: loong64-release
        path: |
          main-loong64
          VERSION
        retention-days: 30
